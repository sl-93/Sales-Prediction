import pandas as pd
import os
import matplotlib.pyplot as plt
import warnings
warnings.filterwarnings("ignore")

class ModelEvaluation:
    def __init__(self, 
                 best_model, 
                 best_params, 
                 train_data, 
                 forecast_data, 
                 feature_importances,
                 days):

        self.best_model = best_model
        self.best_params = best_params
        self.train_data = train_data
        self.forecast_data = forecast_data
        self.feature_importances = feature_importances
        self.days = days

    def run_evaluation(self):
        """
        Evaluates the trained models on the forecast data and generates evaluation metrics and plots.
        """
        for best_model in self.best_model.keys():
            # Create output directory
            os.makedirs(f"output/{best_model}", exist_ok=True)
            
            #Save feature importances
            feat_imp = self.feature_importances[best_model]
            feat_imp.to_excel(f"output/{best_model}/feature_importances.xlsx", index=False)

            # Prepare data for evaluation
            forecast_data_date = self.forecast_data[best_model]["Date"]
            forecast_data = self.forecast_data[best_model].drop(columns=["Date"])
            forecast_data = forecast_data.drop(columns=["WeightQTY_Actual"])
            forecast_data = forecast_data.drop(columns=["SarimaOutput"])

            
            # Generate forecasts
            forecast = self.forecast_output(self.best_model[best_model], forecast_data)


            # plotting results
            self.show_plots(best_model,
                            forecast_data_date,
                            forecast
                            )
            
    
    # function to generate forecast
    def forecast_output(self, model, data):
        """
        Generates forecast using the trained model on the provided data.
        Args:
            model: Trained model to be used for forecasting.
            data (DataFrame): Data on which the forecast is to be generated.
            Returns:
                forecast (ndarray): Forecasted values generated by the model.
        """
        forecast = model.predict(data.values)
        # AND WRITE TO DB
        return forecast
    
    def show_plots(self,
                   best_model,
                   forecast_data_date,
                   forecast
                   ):
        # extract the first and last date for plotting
        first_date = forecast_data_date.iloc[0]
        last_date = forecast_data_date.iloc[-1]
        
        # create the dataframe for output
        forecast_output = pd.DataFrame(forecast, columns=["Forecast"])
        forecast_output['Forecast'] = forecast_output['Forecast'].apply(lambda x: 0 if x < 0 else x)
        forecast_output["WeightQTY"] = self.forecast_data[best_model].WeightQTY_Actual
        forecast_output["Date"] = forecast_data_date
        forecast_output["SarimaOutput"] = self.forecast_data[best_model]["SarimaOutput"]
        forecast_output.to_csv(f"output/{best_model}/forecast.csv")

        # PLot the prediction 
        plt.figure()
        plt.plot(forecast, color = 'r', linewidth = 1, label='forecast')
        plt.plot(self.forecast_data[best_model].WeightQTY_Actual.reset_index(drop=True), color = 'g', linewidth = 1, label='Actual')
        plt.axvline(x = self.days -1 , color = 'b', linewidth = 0.3)
        plt.xticks([0, len(forecast)], [first_date, last_date])
        plt.title("Forecast")
        plt.xlabel("Days")
        plt.ylabel("W")
        plt.legend()
        plt.grid()
        plt.savefig(f"output/{best_model}/Prediction.png")
        plt.close()

        plt.figure()
        plt.plot(self.forecast_data[best_model]["SarimaOutput"], color = 'r', linewidth = 1, label='Sarima')
        plt.plot(forecast, color = 'g', linewidth = 1, label='Forecast')
        plt.xticks([0, len(forecast)], [first_date, last_date])
        plt.title("Forecast VS Sarima")
        plt.xlabel("Days")
        plt.ylabel("W")
        plt.legend()
        plt.grid()
        plt.savefig(f"output/{best_model}/Forecast_VS_Sarima.png")
        plt.close()